$integration: 'http://ibm.com/appconnect/integration/v2/integrationFile'
integration:
  type: trigger-action
  trigger-interfaces:
    trigger-interface-1:
      connector-type: salesforce
      type: event-trigger
      triggers:
        CREATED:
          input-context:
            data: Campaign
          assembly:
            $ref: '#/integration/assemblies/assembly-1'
          options: {}
    trigger-interface-2:
      type: extract-trigger
      triggers:
        RETRIEVEALL:
          input-context:
            data: DB2INST1_Leads
          assembly:
            $ref: '#/integration/assemblies/assembly-2'
      connector-type: ibmdb2
  action-interfaces:
    action-interface-1:
      type: batch-action
      actions:
        START: {}
      options:
        extract:
          $ref: '#/integration/trigger-interfaces/trigger-interface-2'
    action-interface-2:
      type: api-action
      business-object: ClassifyText
      connector-type: watsonnlclassifier
      actions:
        CLASSIFYTEXT: {}
    action-interface-3:
      type: api-action
      business-object: Lead
      connector-type: salesforce
      actions:
        CREATE: {}
    action-interface-4:
      type: api-action
      business-object: CampaignMember
      connector-type: salesforce
      actions:
        CREATE: {}
  assemblies:
    assembly-1:
      assembly:
        execute:
          - batch-retrieve-action:
              name: Batch process
              filter:
                where:
                  conference: '{{$Trigger.Conference__c}}'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
              pagination-type: SKIP_LIMIT
              target:
                $ref: '#/integration/action-interfaces/action-interface-1'
    assembly-2:
      assembly:
        execute:
          - custom-action:
              name: IBM Watson Natural Language Classifier Classify text
              target:
                $ref: '#/integration/action-interfaces/action-interface-2'
              action: CLASSIFYTEXT
              map:
                mappings:
                  - classifier_id:
                      template: 3b0af2x553-nlc-875
                  - text:
                      template: '{{$Batchprocess.leadtxt}}'
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Batchprocess
                    $ref: '#/block/Batch process/current-item'
                  - variable: Trigger
                    $ref: '#/trigger/payload'
          - create-action:
              name: Salesforce Create lead
              target:
                $ref: '#/integration/action-interfaces/action-interface-3'
              map:
                mappings:
                  - City:
                      template: '{{$Batchprocess.city}}'
                  - Company:
                      template: '{{$Batchprocess.company}}'
                  - Country:
                      template: '{{$Batchprocess.country}}'
                  - Description:
                      template: >-
                        {{$exists($Batchprocess.leadtxt)?$Batchprocess.leadtxt
                        :'met at conference' &   $Trigger.Conference__c }}
                  - Email:
                      template: '{{$Batchprocess.email}}'
                  - FirstName:
                      template: '{{$Batchprocess.firstname}}'
                  - LastName:
                      template: '{{$Batchprocess.lastname}}'
                  - Phone:
                      template: '{{$Batchprocess.phone}}'
                  - PostalCode:
                      template: '{{$Batchprocess.postalcd}}'
                  - Rating:
                      template: >-
                        {{$IBMWatsonNaturalLanguageClassifierClassifytext.top_class}}
                  - State:
                      template: '{{$Batchprocess.region}}'
                  - Street:
                      template: >-
                        {{$Batchprocess.address1}}, {{$Batchprocess.address2}},
                        {{$Batchprocess.address3}}, {{$Batchprocess.address4}}
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Batchprocess
                    $ref: '#/block/Batch process/current-item'
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: IBMWatsonNaturalLanguageClassifierClassifytext
                    $ref: >-
                      #/block/Batch process/node-output/IBM Watson Natural
                      Language Classifier Classify text/response/payload
          - create-action:
              name: Salesforce Create campaign member
              target:
                $ref: '#/integration/action-interfaces/action-interface-4'
              map:
                mappings:
                  - CampaignId:
                      template: '{{$Trigger.Id}}'
                  - LeadId:
                      template: '{{$SalesforceCreatelead.Id}}'
                  - Status:
                      template: Received
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Batchprocess
                    $ref: '#/block/Batch process/current-item'
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: IBMWatsonNaturalLanguageClassifierClassifytext
                    $ref: >-
                      #/block/Batch process/node-output/IBM Watson Natural
                      Language Classifier Classify text/response/payload
                  - variable: SalesforceCreatelead
                    $ref: >-
                      #/block/Batch process/node-output/Salesforce Create
                      lead/response/payload
  name: >-
    Populate a Salesforce campaign with leads captured in IBM Db2 and
    cognitively rate each lead
  description: >-
    This template detects when a new campaign is created in Salesforce,
    identifies leads from the associated trade show whose details were stored in
    an IBM Db2 database, and then populates Salesforce with these leads. The
    template also uses cognitive analysis to rate the Salesforce leads as Hot,
    Warm, or Cold.
  todo: >
    To refer to these instructions while editing the flow, open [the github
    page](https://github.com/ot4i/app-connect-templates/blob/master/resources/markdown/Populate%20a%20Salesforce%20campaign%20with%20leads%20captured%20in%20IBM%20Db2%20and%20cognitively%20rate%20each%20lead_instructions.md)
    (opens in a new window).


    ## Prerequisites


    This template references entities that you can create as follows:


    - In your Salesforce instance, create a custom field for the Campaign object
    to uniquely identify the event for which you are creating a campaign. Name
    the custom field **Conference** with a data type of **Text**.

    - In your IBM Db2 instance, create a database table named **LEADS** in the
    **DB2INST1** schema.  Sample DDL:
      `CREATE TABLE LEADS (LEADID SMALLINT NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1), FIRSTNAME VARCHAR(25), LASTNAME VARCHAR(25), FULLNAME VARCHAR(60), ADDRESS1 VARCHAR(255), ADDRESS2 VARCHAR(255), ADDRESS3 VARCHAR(255), ADDRESS4 VARCHAR(255), CITY VARCHAR(25), REGION VARCHAR(25), POSTALCD VARCHAR(25), COUNTRY VARCHAR(25), PHONE VARCHAR(25), COMPANY VARCHAR(255), LEADTXT VARCHAR(255), CONFERENCE VARCHAR(255), EMAIL VARCHAR(60))`

      Insert some sample data into the LEADS table.
    - In your IBM Watson Natural Language Classifier instance, upload some
    training data that defines three classes (**Hot**, **Warm**, and **Cold**)
    and provides sample text about leads for each class. Use this data to train
    a Natural Language Classifier model named **LeadClassifier**. (This model
    will be used to classify the Db2 LEADTXT column values.)



    ## Using the template


    1. Click **Create flow** to start using the template.

    1. Click each node to review its configuration. If necessary:
       - Connect to your [Salesforce account](https://developer.ibm.com/integration/docs/app-connect/how-to-guides-for-apps/use-ibm-app-connect-salesforce/).
       - Connect to your [IBM Db2 account](https://developer.ibm.com/integration/docs/app-connect/how-to-guides-for-apps/use-ibm-app-connect-ibm-db2/).
       - Connect to your [IBM Watson Natural Language Classifier account](https://developer.ibm.com/integration/docs/app-connect/how-to-guides-for-apps/use-ibm-app-connect-watson-natural-language-classifier/).
    1. In the IBM Db2 node, check that the **Where** condition matches the
    CONFERENCE column in the Db2 table to the **Conference** custom field in
    your Salesforce campaign.

    1. In the IBM Watson Natural Language Classifier node, select the correct
    classifier; for example, **LeadClassifier**.

    1. In the Salesforce "Create lead" node, ensure the **Rating** field is
    mapped to the Watson Natural Language Classifier **Top Class** field, which
    identifies the class with the highest confidence.

    1. To start the flow, in the banner open the options menu [&#8942;] and then
    click **Start flow**.
models: {}
