$integration: 'http://ibm.com/appconnect/integration/v2/integrationFile'
integration:
  type: trigger-action
  trigger-interfaces:
    trigger-interface-1:
      type: event-trigger
      triggers:
        UPDATED:
          input-context:
            data: Contact
          assembly:
            $ref: '#/integration/assemblies/assembly-1'
          options: {}
      connector-type: salesforce
  action-interfaces:
    action-interface-1:
      type: api-action
      business-object: BAPI_CUSTOMER_GETDETAIL
      connector-type: sap
      options:
        filter:
          interfaceType: RFC
          transportType: Sync
          search: BAPI_CUSTOMER_GE
      actions:
        INVOKE: {}
    action-interface-2:
      type: notification-card
      actions: {}
      options:
        card:
          layout:
            direction: vertical
            style: layoutA
            items:
              - direction: horizontal
                style: header
                items:
                  - style: icon
                    widget_id: icon
                  - direction: vertical
                    items:
                      - style: title
                        widget_id: nameLabel
                      - style: subtitle
                        widget_id: timestamp
              - direction: vertical
                style: content
                items:
                  - widget_id: descriptionLabel
              - style: buttons
                widget_id: btnGrp1
          widgets:
            - id: icon
              widget: icon
            - id: timestamp
              widget: timestamp
            - id: btnGrp1
              widget: buttonGroup
              widget_ids: []
            - id: nameLabel
              widget: text
              binding: description
              value: New notification
            - id: descriptionLabel
              widget: text
              value: CUSTOMER NOT FOUND
        input:
          - variable: Trigger
            $ref: '#/trigger/payload'
          - variable: SAPInvokeBAPICUSTOMERGETDETAIL
            $ref: '#/node-output/SAP Invoke BAPI_CUSTOMER_GETDETAIL/response/payload'
          - variable: SAPInvokeBAPICUSTOMERGETDETAILMetadata
            $ref: '#/node-output/SAP Invoke BAPI_CUSTOMER_GETDETAIL/response'
    action-interface-3:
      type: api-action
      business-object: BAPI_CUSTOMER_CHANGEFROMDATA
      connector-type: sap
      options:
        filter:
          interfaceType: RFC
          transportType: Sync
          search: BAPI_CUSTOMER_CH
      actions:
        INVOKE: {}
    action-interface-4:
      type: notification-card
      actions: {}
      options:
        card:
          layout:
            direction: vertical
            style: layoutA
            items:
              - direction: horizontal
                style: header
                items:
                  - style: icon
                    widget_id: icon
                  - direction: vertical
                    items:
                      - style: title
                        widget_id: nameLabel
                      - style: subtitle
                        widget_id: timestamp
              - direction: vertical
                style: content
                items:
                  - widget_id: descriptionLabel
              - style: buttons
                widget_id: btnGrp1
          widgets:
            - id: icon
              widget: icon
            - id: timestamp
              widget: timestamp
            - id: btnGrp1
              widget: buttonGroup
              widget_ids: []
            - id: nameLabel
              widget: text
              binding: description
              value: New notification
            - id: descriptionLabel
              widget: text
              value: CUSTOMER FOUND
        input:
          - variable: Trigger
            $ref: '#/trigger/payload'
          - variable: SAPInvokeBAPICUSTOMERCHANGEFROMDATA
            $ref: >-
              #/block/If/node-output/SAP Invoke
              BAPI_CUSTOMER_CHANGEFROMDATA/response/payload
          - variable: SAPInvokeBAPICUSTOMERCHANGEFROMDATAMetadata
            $ref: >-
              #/block/If/node-output/SAP Invoke
              BAPI_CUSTOMER_CHANGEFROMDATA/response
          - variable: SAPInvokeBAPICUSTOMERGETDETAIL
            $ref: '#/node-output/SAP Invoke BAPI_CUSTOMER_GETDETAIL/response/payload'
          - variable: SAPInvokeBAPICUSTOMERGETDETAILMetadata
            $ref: '#/node-output/SAP Invoke BAPI_CUSTOMER_GETDETAIL/response'
    action-interface-5:
      type: notification-card
      actions: {}
      options:
        card:
          layout:
            direction: vertical
            style: layoutA
            items:
              - direction: horizontal
                style: header
                items:
                  - style: icon
                    widget_id: icon
                  - direction: vertical
                    items:
                      - style: title
                        widget_id: nameLabel
                      - style: subtitle
                        widget_id: timestamp
              - direction: vertical
                style: content
                items:
                  - widget_id: descriptionLabel
              - style: buttons
                widget_id: btnGrp1
          widgets:
            - id: icon
              widget: icon
            - id: timestamp
              widget: timestamp
            - id: btnGrp1
              widget: buttonGroup
              widget_ids: []
            - id: nameLabel
              widget: text
              binding: description
              value: New notification
            - id: descriptionLabel
              widget: text
              value: heyoo
        input:
          - variable: Trigger
            $ref: '#/trigger/payload'
  assemblies:
    assembly-1:
      assembly:
        execute:
          - notification:
              name: Notification 3
              map:
                $map: 'http://ibm.com/appconnect/map/v1'
                mappings: []
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
              target:
                $ref: '#/integration/action-interfaces/action-interface-5'
          - custom-action:
              name: SAP Invoke BAPI_CUSTOMER_GETDETAIL
              target:
                $ref: '#/integration/action-interfaces/action-interface-1'
              action: INVOKE
              map:
                mappings:
                  - CustomerToBeRequired:
                      template: '{{$Trigger.SAPCustomerId__c}}'
                  - SalesOrganization:
                      template: '{{$Trigger.Department}}'
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
          - if:
              name: If
              input:
                - variable: Trigger
                  $ref: '#/trigger/payload'
                - variable: SAPInvokeBAPICUSTOMERGETDETAIL
                  $ref: >-
                    #/node-output/SAP Invoke
                    BAPI_CUSTOMER_GETDETAIL/response/payload
                - variable: SAPInvokeBAPICUSTOMERGETDETAILMetadata
                  $ref: '#/node-output/SAP Invoke BAPI_CUSTOMER_GETDETAIL/response'
              branch:
                - condition:
                    '{{$SAPInvokeBAPICUSTOMERGETDETAIL.SapReturn.MessageTypeSSuccessEErrorWWarningIInfoAAbort}}': E
                  execute:
                    - notification:
                        name: Notification
                        map:
                          $map: 'http://ibm.com/appconnect/map/v1'
                          mappings: []
                          input:
                            - variable: Trigger
                              $ref: '#/trigger/payload'
                            - variable: SAPInvokeBAPICUSTOMERGETDETAIL
                              $ref: >-
                                #/node-output/SAP Invoke
                                BAPI_CUSTOMER_GETDETAIL/response/payload
                            - variable: SAPInvokeBAPICUSTOMERGETDETAILMetadata
                              $ref: >-
                                #/node-output/SAP Invoke
                                BAPI_CUSTOMER_GETDETAIL/response
                        target:
                          $ref: '#/integration/action-interfaces/action-interface-2'
              else:
                execute:
                  - custom-action:
                      name: SAP Invoke BAPI_CUSTOMER_CHANGEFROMDATA
                      target:
                        $ref: '#/integration/action-interfaces/action-interface-3'
                      action: INVOKE
                      map:
                        mappings:
                          - CustomerNumberOfTheCustomerToBeChanged:
                              template: '{{$Trigger.SAPCustomerId__c}}'
                          - DistributionChannel:
                              template: >-
                                {{$SAPInvokeBAPICUSTOMERGETDETAIL.DistributionChannel}}
                          - Division:
                              template: '{{$SAPInvokeBAPICUSTOMERGETDETAIL.Division}}'
                          - SalesOrganization:
                              template: '{{$Trigger.Department}}'
                          - SapPiAddress:
                              mappings:
                                - City:
                                    template: '{{$Trigger.MailingCity}}'
                                - CountryKey:
                                    template: >-
                                      {{$SAPInvokeBAPICUSTOMERGETDETAIL.SapPeAddress.CountryKey}}
                                - FirstName:
                                    template: >-
                                      {{$SAPInvokeBAPICUSTOMERGETDETAIL.SapPeAddress.FirstName}}
                                - FormOfAddressForContactPersonMrMrsEtc:
                                    template: >-
                                      {{$SAPInvokeBAPICUSTOMERGETDETAIL.SapPeAddress.FormOfAddressForContactPersonMrMrsEtc}}
                                - HouseNumberAndStreet:
                                    template: >-
                                      {{$SAPInvokeBAPICUSTOMERGETDETAIL.SapPeAddress.HouseNumberAndStreet}}
                                - LanguageKey:
                                    template: >-
                                      {{$SAPInvokeBAPICUSTOMERGETDETAIL.SapPeAddress.LanguageKey}}
                                - Name1:
                                    template: >-
                                      {{$SAPInvokeBAPICUSTOMERGETDETAIL.SapPeAddress.Name1}}
                                - PostalCode:
                                    template: >-
                                      {{$SAPInvokeBAPICUSTOMERGETDETAIL.SapPeAddress.PostalCode}}
                        $map: 'http://ibm.com/appconnect/map/v1'
                        input:
                          - variable: Trigger
                            $ref: '#/trigger/payload'
                          - variable: SAPInvokeBAPICUSTOMERGETDETAIL
                            $ref: >-
                              #/node-output/SAP Invoke
                              BAPI_CUSTOMER_GETDETAIL/response/payload
                          - variable: SAPInvokeBAPICUSTOMERGETDETAILMetadata
                            $ref: >-
                              #/node-output/SAP Invoke
                              BAPI_CUSTOMER_GETDETAIL/response
                  - notification:
                      name: Notification 2
                      map:
                        $map: 'http://ibm.com/appconnect/map/v1'
                        mappings: []
                        input:
                          - variable: Trigger
                            $ref: '#/trigger/payload'
                          - variable: SAPInvokeBAPICUSTOMERCHANGEFROMDATA
                            $ref: >-
                              #/block/If/node-output/SAP Invoke
                              BAPI_CUSTOMER_CHANGEFROMDATA/response/payload
                          - variable: SAPInvokeBAPICUSTOMERCHANGEFROMDATAMetadata
                            $ref: >-
                              #/block/If/node-output/SAP Invoke
                              BAPI_CUSTOMER_CHANGEFROMDATA/response
                          - variable: SAPInvokeBAPICUSTOMERGETDETAIL
                            $ref: >-
                              #/node-output/SAP Invoke
                              BAPI_CUSTOMER_GETDETAIL/response/payload
                          - variable: SAPInvokeBAPICUSTOMERGETDETAILMetadata
                            $ref: >-
                              #/node-output/SAP Invoke
                              BAPI_CUSTOMER_GETDETAIL/response
                      target:
                        $ref: '#/integration/action-interfaces/action-interface-4'
              output-schema: {}
  name: Sync Salesforce and SAP customer contact details
  description: >-
    Use this template to sync data between SAP and Salesforce when a Salesforce
    contact is being updated. The flow will send a trigger from Salesforce to
    SAP whenever the details of a customer contact are being updated and check
    if the same customer exists in SAP using the unique customer ID. If the
    customer exists it will update their details and create a notification that
    the customer was found. If the customer does not exist in SAP it will create
    a notification that there was no such customer.
  todo: >
    To refer to these instructions while editing the flow, open [the github
    page](https://github.com/ot4i/app-connect-templates/blob/master/resources/markdown/Synchronize%20data%20between%20SAP%20and%20Saleforce%20whenever%20the%20salesforce%20contact%20is%20being%20updated_instructions.md)
    (opens in a new window).

    ## Prerequisites

    - To connect to SAP, you need to setup an IBM App Connect Agent while
    creating a connection. To set up, edit, or view the agent, use the Private
    network connections App Connect menu on the App Connect Dashboard.

    ## Using the template

    1. Click **Create flow** to start using the template.

    1. Connect to your [Salesforce
    account](https://developer.ibm.com/integration/docs/app-connect/how-to-guides-for-apps/use-ibm-app-connect-salesforce/).

    1. Connect to your [SAP
    account](https://developer.ibm.com/integration/docs/app-connect/how-to-guides-for-apps/how-to-use-ibm-app-connect-with-sap/),
    choosing the network that you've already created.

    1. Check each node in the flow to review its configuration and, if
    necessary, change the data that will be used.

    1. To start the flow, open the options menu [&#8942;] from the banner, then
    click **Start flow**.

    1. Test your flow by updating an existing contact in your Salesforce
    account.  
     
    When your flow runs, the **If** node checks whether the customerID exists in
    SAP whose contact details got updated in Salesforce. If the same customerID
    exists in SAP, the flow updates the customer data with the specified values
    from your Salesforce account and creates a notification of CUSTOMER FOUND. 
    If the customer doesn't exist in SAP, the flow creates a notification of
    CUSTOMER NOT FOUND. 
models: {}
