$integration: 'http://ibm.com/appconnect/integration/v2/integrationFile'
integration:
  type: trigger-action
  trigger-interfaces:
    trigger-interface-1:
      type: event-trigger
      triggers:
        SCHEDULE:
          input-context:
            data: scheduler
          assembly:
            $ref: '#/integration/assemblies/assembly-1'
          options:
            subscription:
              scheduleConfiguration:
                calendar:
                  cronExp: 00 09 * * *
                  runOnceOncheck: false
                  timeZone: Europe/London
                  every: day
      connector-type: streaming-connector-scheduler
  action-interfaces:
    action-interface-1:
      type: api-action
      business-object: request
      connector-type: http
      actions:
        INVOKE: {}
    action-interface-3:
      type: api-action
      business-object: request
      connector-type: http
      actions:
        INVOKE: {}
    action-interface-2:
      type: api-action
      business-object: request
      connector-type: http
      actions:
        INVOKE: {}
    action-interface-4:
      type: api-action
      business-object: request
      connector-type: http
      actions:
        INVOKE: {}
  assemblies:
    assembly-1:
      assembly:
        execute:
          - if:
              name: If
              input:
                - variable: Trigger
                  $ref: '#/trigger/payload'
              branch:
                - condition:
                    or:
                      - '{{$formatDate($millis(), "dddd", "UTC")}}': Saturday
                      - '{{$formatDate($millis(), "dddd", "UTC")}}': Sunday
                  execute: []
                  completion-action:
                    terminate:
                      info:
                        input:
                          - variable: Trigger
                            $ref: '#/trigger/payload'
                        message: It's the weekend!  No one is in the office today.
                        status-code: 200
              else:
                execute:
                  - logging:
                      name: Log
                      map:
                        $map: 'http://ibm.com/appconnect/map/v1'
                        input:
                          - variable: Trigger
                            $ref: '#/trigger/payload'
                        mappings:
                          - logLevel:
                              template: Info
                          - logMessage:
                              template: >-
                                It's {{$formatDate($millis(), "dddd", "UTC")}} -
                                Checking who is on call.
              output-schema: {}
          - custom-action:
              name: HTTP Invoke method
              target:
                $ref: '#/integration/action-interfaces/action-interface-1'
              action: INVOKE
              map:
                customSchemas:
                  properties.`requestHeaders`:
                    type: object
                    properties:
                      Accept:
                        type: string
                      Authorization:
                        type: string
                mappings:
                  - continue2xx:
                      expression: 'false'
                  - method:
                      template: GET
                  - requestHeaders:
                      mappings:
                        - Accept:
                            template: application/vnd.pagerduty+json;version=2
                        - Authorization:
                            template: Token token=
                  - url:
                      template: >-
                        https://api.pagerduty.com/oncalls?time_zone=UTC&include%5B%5D=users&schedule_ids%5B%5D=&earliest=true
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
          - parse:
              name: JSON Parser Parse
              parse-format: json
              source:
                template: '{{$HTTPInvokemethod.responseBody}}'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: HTTPInvokemethod
                    $ref: '#/node-output/HTTP Invoke method/response/payload'
                  - variable: HTTPInvokemethodMetadata
                    $ref: '#/node-output/HTTP Invoke method/response'
              sample-data: ''
              output-schema:
                $schema: 'http://json-schema.org/draft-04/schema#'
                type: object
                properties:
                  oncalls:
                    type: array
                    items:
                      type: object
                      properties:
                        escalation_policy:
                          type: object
                          properties:
                            id:
                              type: string
                            type:
                              type: string
                            summary:
                              type: string
                            self:
                              type: string
                            html_url:
                              type: string
                        escalation_level:
                          type: number
                        schedule:
                          type: object
                          properties:
                            id:
                              type: string
                            type:
                              type: string
                            summary:
                              type: string
                            self:
                              type: string
                            html_url:
                              type: string
                        user:
                          type: object
                          properties:
                            name:
                              type: string
                            email:
                              type: string
                            time_zone:
                              type: string
                            color:
                              type: string
                            avatar_url:
                              type: string
                            billed:
                              type: boolean
                            role:
                              type: string
                            description:
                              type: 'null'
                            invitation_sent:
                              type: boolean
                            job_title:
                              type: 'null'
                            teams:
                              type: array
                              items:
                                type: object
                                properties:
                                  id:
                                    type: string
                                  type:
                                    type: string
                                  summary:
                                    type: string
                                  self:
                                    type: string
                                  html_url:
                                    type: string
                            contact_methods:
                              type: array
                              items:
                                type: object
                                properties:
                                  id:
                                    type: string
                                  type:
                                    type: string
                                  summary:
                                    type: string
                                  self:
                                    type: string
                                  html_url:
                                    type: 'null'
                            notification_rules:
                              type: array
                              items:
                                type: object
                                properties:
                                  id:
                                    type: string
                                  type:
                                    type: string
                                  summary:
                                    type: string
                                  self:
                                    type: string
                                  html_url:
                                    type: 'null'
                            coordinated_incidents:
                              type: array
                              items: {}
                            id:
                              type: string
                            type:
                              type: string
                            summary:
                              type: string
                            self:
                              type: string
                            html_url:
                              type: string
                        start:
                          type: string
                        end:
                          type: string
                  limit:
                    type: number
                  offset:
                    type: number
                  more:
                    type: boolean
                  total:
                    type: 'null'
                title: Parsed JSON
          - logging:
              name: Log 2
              map:
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: HTTPInvokemethod
                    $ref: '#/node-output/HTTP Invoke method/response/payload'
                  - variable: HTTPInvokemethodMetadata
                    $ref: '#/node-output/HTTP Invoke method/response'
                  - variable: JSONParserParse
                    $ref: '#/node-output/JSON Parser Parse/response/payload'
                mappings:
                  - logLevel:
                      template: Info
                  - logMessage:
                      template: >-
                        {{$JSONParserParse.oncalls.user.name}} is on shift.
                        Finding out their Slack username.
          - custom-action:
              name: HTTP Invoke method 2
              target:
                $ref: '#/integration/action-interfaces/action-interface-3'
              action: INVOKE
              map:
                customSchemas:
                  properties.`requestHeaders`:
                    type: object
                    properties:
                      Accept:
                        type: string
                mappings:
                  - continue2xx:
                      expression: 'false'
                  - method:
                      template: GET
                  - requestHeaders:
                      mappings:
                        - Accept:
                            template: application/x-www-form-urlencoded
                  - url:
                      template: >-
                        https://my-company.slack.com/api/users.lookupByEmail?token=&email={{$JSONParserParse.oncalls.user.email}}
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: HTTPInvokemethod
                    $ref: '#/node-output/HTTP Invoke method/response/payload'
                  - variable: HTTPInvokemethodMetadata
                    $ref: '#/node-output/HTTP Invoke method/response'
                  - variable: JSONParserParse
                    $ref: '#/node-output/JSON Parser Parse/response/payload'
          - parse:
              name: JSON Parser Parse 2
              parse-format: json
              source:
                template: '{{$HTTPInvokemethod2.responseBody}}'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: HTTPInvokemethod
                    $ref: '#/node-output/HTTP Invoke method/response/payload'
                  - variable: HTTPInvokemethodMetadata
                    $ref: '#/node-output/HTTP Invoke method/response'
                  - variable: JSONParserParse
                    $ref: '#/node-output/JSON Parser Parse/response/payload'
                  - variable: HTTPInvokemethod2
                    $ref: '#/node-output/HTTP Invoke method 2/response/payload'
                  - variable: HTTPInvokemethod2Metadata
                    $ref: '#/node-output/HTTP Invoke method 2/response'
              sample-data: ''
              output-schema:
                $schema: 'http://json-schema.org/draft-04/schema#'
                type: object
                properties:
                  ok:
                    type: boolean
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                      team_id:
                        type: string
                      name:
                        type: string
                      deleted:
                        type: boolean
                      color:
                        type: string
                      real_name:
                        type: string
                      tz:
                        type: string
                      tz_label:
                        type: string
                      tz_offset:
                        type: number
                      profile:
                        type: object
                        properties:
                          avatar_hash:
                            type: string
                          status_text:
                            type: string
                          status_emoji:
                            type: string
                          real_name:
                            type: string
                          display_name:
                            type: string
                          real_name_normalized:
                            type: string
                          display_name_normalized:
                            type: string
                          email:
                            type: string
                          image_24:
                            type: string
                          image_32:
                            type: string
                          image_48:
                            type: string
                          image_72:
                            type: string
                          image_192:
                            type: string
                          image_512:
                            type: string
                          team:
                            type: string
                      is_admin:
                        type: boolean
                      is_owner:
                        type: boolean
                      is_primary_owner:
                        type: boolean
                      is_restricted:
                        type: boolean
                      is_ultra_restricted:
                        type: boolean
                      is_bot:
                        type: boolean
                      updated:
                        type: number
                      is_app_user:
                        type: boolean
                      has_2fa:
                        type: boolean
                title: Parsed JSON
          - logging:
              name: Log 3
              map:
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: HTTPInvokemethod
                    $ref: '#/node-output/HTTP Invoke method/response/payload'
                  - variable: HTTPInvokemethodMetadata
                    $ref: '#/node-output/HTTP Invoke method/response'
                  - variable: JSONParserParse
                    $ref: '#/node-output/JSON Parser Parse/response/payload'
                  - variable: HTTPInvokemethod2
                    $ref: '#/node-output/HTTP Invoke method 2/response/payload'
                  - variable: HTTPInvokemethod2Metadata
                    $ref: '#/node-output/HTTP Invoke method 2/response'
                  - variable: JSONParserParse2
                    $ref: '#/node-output/JSON Parser Parse 2/response/payload'
                mappings:
                  - logLevel:
                      template: Info
                  - logMessage:
                      template: >-
                        Adding {{$JSONParserParse2.user.name}} to Slack group
                        @slack-group-name
          - custom-action:
              name: HTTP Invoke method 3
              target:
                $ref: '#/integration/action-interfaces/action-interface-2'
              action: INVOKE
              map:
                customSchemas: {}
                mappings:
                  - continue2xx:
                      expression: 'false'
                  - method:
                      template: POST
                  - url:
                      template: >-
                        https://my-company.slack.com/api/usergroups.users.update?token=&usergroup=&users={{$JSONParserParse2.user.id}}
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: HTTPInvokemethod
                    $ref: '#/node-output/HTTP Invoke method/response/payload'
                  - variable: HTTPInvokemethodMetadata
                    $ref: '#/node-output/HTTP Invoke method/response'
                  - variable: JSONParserParse
                    $ref: '#/node-output/JSON Parser Parse/response/payload'
                  - variable: HTTPInvokemethod2
                    $ref: '#/node-output/HTTP Invoke method 2/response/payload'
                  - variable: HTTPInvokemethod2Metadata
                    $ref: '#/node-output/HTTP Invoke method 2/response'
                  - variable: JSONParserParse2
                    $ref: '#/node-output/JSON Parser Parse 2/response/payload'
          - logging:
              name: Log 4
              map:
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: HTTPInvokemethod
                    $ref: '#/node-output/HTTP Invoke method/response/payload'
                  - variable: HTTPInvokemethodMetadata
                    $ref: '#/node-output/HTTP Invoke method/response'
                  - variable: JSONParserParse
                    $ref: '#/node-output/JSON Parser Parse/response/payload'
                  - variable: HTTPInvokemethod2
                    $ref: '#/node-output/HTTP Invoke method 2/response/payload'
                  - variable: HTTPInvokemethod2Metadata
                    $ref: '#/node-output/HTTP Invoke method 2/response'
                  - variable: JSONParserParse2
                    $ref: '#/node-output/JSON Parser Parse 2/response/payload'
                  - variable: HTTPInvokemethod3
                    $ref: '#/node-output/HTTP Invoke method 3/response/payload'
                  - variable: HTTPInvokemethod3Metadata
                    $ref: '#/node-output/HTTP Invoke method 3/response'
                mappings:
                  - logLevel:
                      template: Info
                  - logMessage:
                      template: Updating Slack channel topic with callout details.
          - custom-action:
              name: HTTP Invoke method 4
              target:
                $ref: '#/integration/action-interfaces/action-interface-4'
              action: INVOKE
              map:
                customSchemas: {}
                mappings:
                  - continue2xx:
                      expression: 'false'
                  - method:
                      template: POST
                  - url:
                      template: >-
                        https://my-company.slack.com/api/channels.setTopic?token=&channel=&topic=@{{$JSONParserParse2.user.name}}
                        is on call - contact via @slack-group-name
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: HTTPInvokemethod
                    $ref: '#/node-output/HTTP Invoke method/response/payload'
                  - variable: HTTPInvokemethodMetadata
                    $ref: '#/node-output/HTTP Invoke method/response'
                  - variable: JSONParserParse
                    $ref: '#/node-output/JSON Parser Parse/response/payload'
                  - variable: HTTPInvokemethod2
                    $ref: '#/node-output/HTTP Invoke method 2/response/payload'
                  - variable: HTTPInvokemethod2Metadata
                    $ref: '#/node-output/HTTP Invoke method 2/response'
                  - variable: JSONParserParse2
                    $ref: '#/node-output/JSON Parser Parse 2/response/payload'
                  - variable: HTTPInvokemethod3
                    $ref: '#/node-output/HTTP Invoke method 3/response/payload'
                  - variable: HTTPInvokemethod3Metadata
                    $ref: '#/node-output/HTTP Invoke method 3/response'
          - logging:
              name: Log 5
              map:
                $map: 'http://ibm.com/appconnect/map/v1'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: HTTPInvokemethod
                    $ref: '#/node-output/HTTP Invoke method/response/payload'
                  - variable: HTTPInvokemethodMetadata
                    $ref: '#/node-output/HTTP Invoke method/response'
                  - variable: JSONParserParse
                    $ref: '#/node-output/JSON Parser Parse/response/payload'
                  - variable: HTTPInvokemethod2
                    $ref: '#/node-output/HTTP Invoke method 2/response/payload'
                  - variable: HTTPInvokemethod2Metadata
                    $ref: '#/node-output/HTTP Invoke method 2/response'
                  - variable: JSONParserParse2
                    $ref: '#/node-output/JSON Parser Parse 2/response/payload'
                  - variable: HTTPInvokemethod3
                    $ref: '#/node-output/HTTP Invoke method 3/response/payload'
                  - variable: HTTPInvokemethod3Metadata
                    $ref: '#/node-output/HTTP Invoke method 3/response'
                  - variable: HTTPInvokemethod4
                    $ref: '#/node-output/HTTP Invoke method 4/response/payload'
                  - variable: HTTPInvokemethod4Metadata
                    $ref: '#/node-output/HTTP Invoke method 4/response'
                mappings:
                  - logLevel:
                      template: Info
                  - logMessage:
                      template: Slack topic successfully set!
  name: Get PagerDuty schedule then update Slack group and topic
  description: >-
    Use this template to manage members of a Slack group based on a PagerDuty
    schedule.
  todo: >
    To refer to these instructions while editing the flow, open [the github
    page](https://github.com/ot4i/app-connect-templates/blob/marion-pdtoslack/resources/markdown/Get%20PagerDuty%20schedule%20and%20update%20Slack%20user%20group%20and%20topic_instructions.md)
    (opens in a new window).


    Before you use this flow, you must have:


    ### PagerDuty


    **Schedule**

    You will need to know the ID for the schedule you wish to query.  The number
    at the end of the URL when viewing the schedule (e.g.
    https://my-company.pagerduty.com/schedules#AB12345).


    **v2 API user token**

    - You can create this in PagerDuty under the **User Settings** tab on **My
    Profile**.

    - Copy the API key as this will be required in the flow.


    ### Slack


    **User group**

    You will need to know the ID for the user group you wish to update.  The
    number at the end of the URL when viewing the group (e.g.
    https://my-company.slack.com/usergroups/CD12345).


    **Channel**

    You will need to know the ID for the channel whose topic you wish to
    update.  The number at the end of the URL when viewing the channel (e.g.
    https://my-company.slack.com/messages/EF12345).


    **Slack App**

    You can create this from the [Slack apps](https://api.slack.com/apps/) page.


    1. Click **Create New App**, then give your app a name and select the
    `Workspace` you wish to interact with.

    1. Click **Create App**

    1. Click on **Permissions**, then under **Scopes** use the dropdown to add
    the following permission scopes:
        - channels:write
        - usergroups:write
        - users:read
        - users:read.email
    1. Click **Save Changes**

    1. Click **Install App to Workspace**

    1. Click **Authorize**

    1. Copy the OAuth Access Token as this will be required in the flow.


    ## Using the template


    1. Click **Create flow** to start using the template.

    1. Click on the first **HTTP** node, and create a HTTP account.  You do not
    need to provide any of the optional details, click to connect.

    1. Update the URL to include your PagerDuty schedule ID between
    `schedule_ids%5B%5D=` and `&earliest`.

    1. Update the Authorization request header to include your PagerDuty API
    token after `Token token=`.

    1. Click on the second **HTTP** node, and connect to your HTTP account.

    1. Update the URL to match your Slack workspace domain (e.g.
    https://my-company.slack.com) and include your OAuth Access Token between
    `token=` and `&email`.

    1. Click on the third **HTTP** node, and connect to your HTTP account.

    1. Again, update the URL to match your Slack workspace domain (e.g.
    https://my-company.slack.com) and include your OAuth Access Token between
    `token=` and `&usergroup`.  Also, include your user group ID between
    `usergroup=` and `&users`.

    1. Click on the fourth **HTTP** node, and connect to your HTTP account.

    1. Again, update the URL to match your Slack workspace domain (e.g.
    https://my-company.slack.com) and include your OAuth Access Token between
    `token=` and `&channel`.  Also, include your channel ID between `channel=`
    and `&topic`.

    1. To start the flow, in the banner open the options menu [&#8942;] then
    click **Start flow**.
models: {}
